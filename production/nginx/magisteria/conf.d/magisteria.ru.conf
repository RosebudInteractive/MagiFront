    upstream magisteria_upstream {
        server 127.0.0.1:3001;
        server 127.0.0.1:3002;
        server 127.0.0.1:3003;
        server 127.0.0.1:3004;
    }

    server {

        access_log /var/log/nginx/magisteria-access.log magisteria;
        error_log /var/log/nginx/magisteria-error.log;

        server_name magisteria.ru;
        client_max_body_size 128m;
        root /home/sites/magisteria.ru/MagisteriaTwo;

        set $static_internal data-internal;
        set $download_internal download-internal;
    
        location ~* "^/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/"
        {
            #
            # prevent attacks to node instances
            # ex: GET /2D1C4FA9-117C-C34D-A0B2-1AA57EEF3E67/websocket?url=https%3A%2F%2Fmagisteria.ru%2Fdostoevsky%2Ffantastic%3Ffbclid%3DIwAR2-
            #
            return 501;
        }

        location /feed/zen
        {
            root /home/sites/magisteria.ru/feed;
            try_files /yandex-zen.xml =404;
        }

        location /feed
        {
            root /home/sites/magisteria.ru/feed;
            try_files /magisteria-rss.xml =404;
        }

        location /doc
        {
            root /home/sites/magisteria.ru/MagisteriaTwo/static-files;
            try_files $uri =404;
        }

        location ~ ^/.*sitemap.*.xsl
        {
            root /home/sites/magisteria.ru/sitemaps/xsl;
            try_files $uri =404;
        }

        location ~ ^/(robots.txt|.*sitemap.*.xml)
        {
            root /home/sites/magisteria.ru/sitemaps;
            try_files $uri =404;
        }

        location ~ ^/(sp-push-manifest.json|sp-push-worker.js|sp-push-worker-fb.js)
        {
            root /home/sites/magisteria.ru/push-plugin;
            try_files $uri =404;
        }

        location ~ ^/yandex.*\.html
        {
            root /home/sites/magisteria.ru/yandex;
            try_files $uri =404;
        }

        location ~ ^/google.*\.html
        {
            root /home/sites/magisteria.ru/google;
            try_files $uri =404;
        }

        location ~ ^/(assets|fonts|scripts|static)/
        {
            add_header Cache-Control no-cache; # development config
            root /home/sites/magisteria.ru/MagisteriaTwo;
            try_files $uri =404;
        }

        location ~ ^/(images|css)/
        {
            add_header Cache-Control no-cache; # development config
            root /home/sites/magisteria.ru/MagisteriaTwo;
            try_files $uri /assets/$uri =404;
        }

        location ~ ^/_dwld_/ {
    	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    	    proxy_set_header Host $http_host;
    	    proxy_set_header X-Forwarded-Proto $scheme;
    	    proxy_set_header X-NginX-Proxy true;
    	    proxy_set_header X-NginX-Static $download_internal;
	    proxy_set_header X-Real-IP $remote_addr;
    	    proxy_http_version 1.1;
    	    proxy_set_header Upgrade $http_upgrade;
    	    proxy_set_header Connection "upgrade";
    	    proxy_max_temp_file_size 0;
    	    proxy_pass http://magisteria_upstream;
    	    proxy_redirect off;
    	    proxy_read_timeout 240s;
        }

        location /download-internal/ { # unfortunately can't use variable "$download_internal" here
           internal;

           limit_rate 1000k;
           limit_conn srv 10;

           alias /home/sites/magisteria.ru/uploads/; #note the trailing slash
        }

        location / {
    	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    	    proxy_set_header Host $http_host;
    	    proxy_set_header X-Forwarded-Proto $scheme;
    	    proxy_set_header X-NginX-Proxy true;
    	    proxy_set_header X-NginX-Static $static_internal;
	    proxy_set_header X-Real-IP $remote_addr;
    	    proxy_http_version 1.1;
    	    proxy_set_header Upgrade $http_upgrade;
    	    proxy_set_header Connection "upgrade";
    	    proxy_max_temp_file_size 0;
    	    proxy_pass http://magisteria_upstream/;
    	    proxy_redirect off;
    	    proxy_read_timeout 240s;
        }

        location /data-internal/ { # unfortunately can't use variable "$static_internal" here
           internal;
           alias /home/sites/magisteria.ru/uploads/; #note the trailing slash
        }

        #
        # Should be commented to avoid resolving to "/" location
        #
        #error_page 404 /404.html;
        #    location = /40x.html {
        #}
        #
        #error_page 500 502 503 504 /50x.html;
        #    location = /50x.html {
        #}

        listen [::]:443 ssl ipv6only=on; # managed by Certbot
        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/nginx/ssl/nginx.magisteria.crt; #magisteria_ru.crt; #	/var/lib/letsencrypt/snakeoil/0001_cert.pem; # managed by Certbot
        ssl_certificate_key /etc/nginx/ssl/private.key; #	/var/lib/letsencrypt/snakeoil/0001_key.pem; # managed by Certbot
        #include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        #ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS';
        ssl_prefer_server_ciphers on;
    }

    server {
        if ($host = magisteria.ru) {
            return 301 https://$host$request_uri;
        } # managed by Certbot
        if ($host = www.magisteria.ru) {
            return 301 https://magisteria.ru$request_uri;
        } # managed by Certbot


        server_name magisteria.ru www.magisteria.ru;

        listen 80;
        listen [::]:80;
        return 404; # managed by Certbot

    }
